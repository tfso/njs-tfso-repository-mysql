{"version":3,"file":"querystream.js","sourceRoot":"","sources":["../../src/test/querystream.ts"],"names":[],"mappings":"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","sourcesContent":["import assert = require('assert');\n\nimport * as MySql from 'mysql';\n\nimport { QueryStream } from './../db/querystream';\nimport { ConnectionMock } from './base/connectionmock';\n\nimport { SkipOperator } from 'tfso-repository/lib/linq/operators/skipoperator';\nimport { TakeOperator } from 'tfso-repository/lib/linq/operators/takeoperator';\n\ndescribe(\"When using QueryStream for MySql queries\", () => {\n    var myQuery: Select,\n        data: Array<any>;\n\n    beforeEach(() => {\n        data = [\n            { no: 1, name: 'ABC' },\n            { no: 2, name: 'DEF' },\n            { no: 3, name: 'GHI' },\n            { no: 4, name: 'JKL' },\n            { no: 5, name: 'MNO' },\n            { no: 6, name: 'PQR' },\n            { no: 7, name: 'STU' },\n            { no: 8, name: 'VWX' },\n            { no: 9, name: 'YZÆ' },\n            { no: 10, name: 'ØÅ1' },\n            { no: 11, name: '234' },\n            { no: 12, name: '567' },\n            { no: 13, name: '890' }\n        ];\n\n        myQuery = new Select(data);\n    })\n\n    it(\"should return all records\", () => {\n        return myQuery\n            .then(recordset => {\n\n                assert.equal(recordset.records.length, 13);\n            });\n    })\n\n    it(\"should handle paging\", () => {\n        myQuery.query.skip(3).take(5);\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 5);\n                assert.equal(recordset.records[0].name, \"JKL\");\n            });\n    })\n\n    it(\"should handle paging with total count for in-memory paging\", () => {\n        myQuery = new Select([]);\n        myQuery.query.where(it => it.no > 5).skip(3).take(5);\n\n        myQuery.data = data\n            .map(el => {\n                return {\n                    no: el.no,\n                    name: el.name,\n                    pagingTotalCount: 8\n                };\n            }); // totalLength is only available for stream when we have a column named pagingTotalCount (for optimizations)\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 5);\n                assert.equal(recordset.totalLength, 8);\n                assert.equal(recordset.records[0].name, \"YZÆ\");\n            })\n    })\n\n    it(\"should handle paging with total count for database paging\", () => {\n        myQuery = new Select([]);\n        myQuery.query.where(it => it.no > 5).skip(3).take(5);\n\n\n        // since database is doing its paging we should remove the operators\n        let skip = myQuery.query.operations.first(SkipOperator);\n        let take = myQuery.query.operations.first(TakeOperator);\n\n        myQuery.query.operations.remove(skip);\n        myQuery.query.operations.remove(take);\n\n        // faking database paging now\n        data = data\n            .map(el => {\n                return {\n                    no: el.no,\n                    name: el.name,\n                    pagingTotalCount: 8\n                };\n            })\n            .filter(it => {\n                return it.no > 5\n            })\n            .slice((<SkipOperator<IModel>>skip).count, (<TakeOperator<IModel>>take).count + (<TakeOperator<IModel>>take).count);\n\n        myQuery.data = data;\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 5);\n                assert.equal(recordset.totalLength, 8);\n                assert.equal(recordset.records[0].name, \"YZÆ\");\n            })\n    })\n\n    it(\"should be able to skip rows\", () => {\n        myQuery.query.skip(10);\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 3);\n                assert.equal(recordset.records[0].name, \"234\");\n            });\n    })\n\n    it(\"should be able to take rows\", () => {\n        myQuery.query.take(5);\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 5);\n            });\n    })\n\n    it(\"should be able to override skipping of rows\", () => {\n        myQuery.query.skip(3).take(5);\n\n        var skip = myQuery.query.operations.values().next().value;\n            \n        myQuery.query.operations.remove(skip);\n\n        return myQuery\n            .then(recordset => {\n                assert.equal(recordset.records.length, 5);\n                assert.equal(recordset.records[0].name, \"ABC\");\n            });\n    })\n\n    it(\"should fail for driver/query problems\", (done) => {\n        myQuery.shouldFail = true;\n\n        myQuery\n            .then((model) => {\n                done(new Error('Expected Query promise to fail'));\n            }, (err) => {\n                if (err.message.toLowerCase() == 'internal mysql error')\n                    done();\n                else\n                    done(err);\n            });\n    })\n\n    it(\"should fail for driver/query problems using catch\", (done) => {\n        myQuery.shouldFail = true;\n\n        myQuery\n            .then((model) => {\n                done(new Error('Expected Query promise to fail'));\n            })\n            .catch((err) => {\n                if (err.message.toLowerCase() == 'internal mysql error')\n                    done();\n                else\n                    done(err);\n            });\n    })\n\n    it(\"should fail for driver/query problems using only catch\", (done) => {\n        myQuery.shouldFail = true;\n\n        myQuery\n            .catch((err) => {\n                if (err.message.toLowerCase() == 'internal mysql error')\n                    done();\n                else\n                    done(err);\n            });\n    })\n\n    it(\"should fail for driver/query problems using nested catch\", (done) => {\n        myQuery.shouldFail = true;\n\n        Promise.resolve(\n            myQuery.then(() => {\n                done(new Error('Never going to hit'));\n            })\n        )\n            .catch((err) => {\n                if (err.message.toLowerCase() == 'internal mysql error')\n                    done();\n                else\n                    done(err);\n            });\n    })\n})\n\ninterface IModel {\n    no: number\n    name: string\n}\n\nclass Select extends QueryStream<IModel>\n{\n    // for mocking\n    public shouldFail = false;\n\n    constructor(public data: Array<any>) {\n        super();\n\n        this.commandText = \"SELECT *\";\n    }\n\n    protected transform(record) {\n        return <IModel>{\n            no: record.no,\n            name: record.name\n        };\n    }\n\n    /**\n     * Overriding for mocking as we don't have a valid MsSql connection and request\n     */\n    protected createConnection(): MySql.Connection {\n        return new ConnectionMock(this.data, this.shouldFail);\n    }\n}"]}